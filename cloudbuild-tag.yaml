steps:
- name: 'gcr.io/cloud-builders/gsutil'
  id: get-artifact
  args:
    - cp 
    - 'gs://${_ARTIFACT_BUCKET_}/workbench/$SHORT_SHA/dist.tar.gz'
    - '.'
- name: 'gcr.io/cloud-builders/gcloud'
  id: deflate
  entrypoint: /bin/sh
  args:
    - -c
    - |
      tar xvzf dist.tar.gz -C ./
  waitFor:
    - get-artifact
- name: 'gcr.io/cloud-builders/gsutil'
  id: copy-environs
  args:
    - cp
    - -r
    - 'gs://${_TARGET_PROJECT_}-configs/workbench/src/environments/'
    - ./dist/
  waitFor:
    - deflate
- name: 'gcr.io/cloud-builders/gsutil'
  id: copy-app
  args:
    - cp
    - 'gs://${_TARGET_PROJECT_}-configs/workbench/src/app.yaml'
    - ./dist/
  waitFor:
    - deflate
- name: 'gcr.io/cloud-builders/gcloud'
  id: deploy
  args:
    - app
    - deploy
    - ./dist/app.yaml
    - --project=${_TARGET_PROJECT_}
  waitFor:
    - copy-app
    - copy-environs
  